---
title: "Clue Search"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(ggplot2)
library(ggthemes)
library(pwr)
library(Hmisc)
```

```{r data, message=FALSE, warning=FALSE}
clue_search <- read_csv("Data/clue_search_data.csv") %>%
  filter(complete.cases(.))

operators <- read_csv("Data/operators.csv")

dates <- clue_search %>%
  distinct(date)

operators_by_date <- dates %>%
  full_join(operators, by = c("date" = "from")) %>%
  complete(date, operator) %>%
  group_by(operator) %>%
  fill(rank, level, faction, bonus, .direction = "down") %>%
  filter(!is.na(operator))
  

clue_search <- clue_search %>%
  left_join(operators_by_date, by = c("date", "operator_1" = "operator")) %>%
  left_join(operators_by_date, by = c("date", "operator_2" = "operator"), suffix = c("_1", "_2"))

rm(dates, operators_by_date)
```


```{r summary, message=FALSE, warning=FALSE}
clue_search %>%
  group_by(operator_1, operator_2) %>%
  summarise(n = n()) %>%
  arrange(-n)
```

# Graphs
```{r operators, message=FALSE, warning=FALSE}
data_operators <- clue_search %>%
  select(operator_1, operator_2) %>%
  pivot_longer(cols = c(operator_1, operator_2),
               values_to = "operator") %>%
  group_by(operator) %>%
  summarise(n = n()) %>%
  mutate(prop = n / sum(n) * 2) %>%
  arrange(-prop) %>%
  mutate(operator = factor(operator, .$operator))

p_01_operators <- data_operators %>%
  ggplot(aes(x = operator, y = prop)) +
  geom_col() +
  labs(y = "", title = "Operators Used",
       subtitle = "Per cent of clue searches",
       caption = "Source: vienne") +
  scale_y_continuous(labels = scales::percent) +
  theme_fivethirtyeight()

p_01_operators
```


```{r clue frequency, message=FALSE, warning=FALSE}
data_clue_search <- clue_search %>%
  filter(bonus_1 == 0, bonus_2 == 0) %>%
  group_by(clue) %>%
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n),
         y_lower = binconf(n, sum(n))[,2],
         y_upper = binconf(n, sum(n))[,3])


caption <- paste0("n = ",
                  sum(data_clue_search$n),
                  "\nSource: vienne")

p_02_clue_share <- data_clue_search %>%
  ggplot(aes(x = clue, y = prop)) +
  geom_col() +
  labs(y = "", title = "Frequency of Clues",
       subtitle = "Operators without Clue Faction bonus",
       caption = caption) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = 1:7) +
  theme_fivethirtyeight()
  
  
p_02_clue_share
```

```{r rhodes island, message=FALSE, warning=FALSE}
data_rhodes_island <- clue_search %>%
  filter(bonus_1 == 0, bonus_2 == 0) %>%
  mutate(rhodes_island = if_else(faction_1 == "rhodes_island" | faction_2 == "rhodes_island",
                                 "Rhodes Island",
                                 "No Rhodes Island")) %>%
  group_by(rhodes_island, clue) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  complete(rhodes_island, clue, fill = list(`n` = 0)) %>%
  group_by(rhodes_island) %>%
  mutate(prop = n / sum(n),
         y_lower = binconf(n, sum(n))[,2],
         y_upper = binconf(n, sum(n))[,3],
         rhodes_island = factor(rhodes_island, levels = c("Rhodes Island",
                                                          "No Rhodes Island"))) 


caption <- paste0("Source: vienne")

p_03_rhodes_island <- data_rhodes_island %>%
  ggplot(aes(x = clue, y = prop, fill = rhodes_island)) +
  geom_col(position = position_dodge()) +
  labs(y = "", title = "Do Rhodes Island Operators Increase Clue Seven?",
       subtitle = "Frequency of clues by operator faction",
       caption = caption) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = 1:7) +
  geom_errorbar(aes(ymin=y_lower, ymax=y_upper), width=.2,
                 position=position_dodge(.9)) +
  theme_fivethirtyeight() +
  ggthemes::scale_fill_fivethirtyeight() +
  theme(legend.title = element_blank())
  
p_03_rhodes_island
```

```{r reception, message=FALSE, warning=FALSE}
data_reception <- clue_search %>%
  filter(bonus_1 == 0 | bonus_2 == 0) %>%
  mutate(reception_room = if_else(reception_room == 1,
                                 "Reception room",
                                 "Operator")) %>%
  group_by(reception_room, clue) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  complete(reception_room, clue, fill = list(`n` = 0)) %>%
  group_by(reception_room) %>%
  mutate(prop = n / sum(n),
         y_lower = binconf(n, sum(n))[,2],
         y_upper = binconf(n, sum(n))[,3],
         reception_room = factor(reception_room, levels = c("Reception room",
                                                            "Operator"))) 


caption <- paste0("Source: vienne")

p_04_reception <- data_reception %>%
  ggplot(aes(x = clue, y = prop, fill = reception_room)) +
  geom_col(position = position_dodge()) +
  labs(y = "", title = "Does the Reception Room Matter?",
       subtitle = "Frequency by clue source, operators with no bonus",
       caption = caption) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = 1:7) +
  geom_errorbar(aes(ymin=y_lower, ymax=y_upper), width=.2,
                 position=position_dodge(.9)) +
  theme_fivethirtyeight() +
  ggthemes::scale_fill_fivethirtyeight() +
  theme(legend.title = element_blank())
  
p_04_reception
```

```{r jessica, message=FALSE, warning=FALSE}
data_jessica <- clue_search %>%
  filter(bonus_1 %in% c(0, 3), bonus_2 %in% c(0, 3)) %>%
  mutate(jessica = if_else(operator_1 == "Jessica" | operator_2 == "Jessica",
                           "Jessica",
                           "No bonus")) %>%
  group_by(jessica, clue) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  complete(jessica, clue, fill = list(`n` = 0)) %>%
  group_by(jessica) %>%
  mutate(prop = n / sum(n),
         y_lower = binconf(n, sum(n))[,2],
         y_upper = binconf(n, sum(n))[,3],
         jessica = factor(jessica, levels = c("No bonus",
                                              "Jessica"))) 


caption <- paste0("Source: vienne")

p_05_jessica <- data_jessica %>%
  ggplot(aes(x = clue, y = prop, fill = jessica)) +
  geom_col(position = position_dodge()) +
  labs(y = "", title = "The Effect of Jessica",
       subtitle = "Frequency of clues by operator type",
       caption = caption) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = 1:7) +
  geom_errorbar(aes(ymin=y_lower, ymax=y_upper), width=.2,
                 position=position_dodge(.9)) +
  theme_fivethirtyeight() +
  ggthemes::scale_fill_fivethirtyeight() +
  theme(legend.title = element_blank())
  
p_05_jessica
```

```{r hypothesis test equal probabilities}
clues <- data_clue_search$n
res <- chisq.test(clues)
res

null <- rep(1/7, 7)
alt <- c(data_clue_search$prop)
pwr.chisq.test(w=ES.w1(null,alt), df=(7-1), sig.level=0.05, power = .8)
```

```{r export graphs, message=FALSE, warning=FALSE}
dir.create("Graphs")

mylist <- mget(ls(pattern = "p_"))

names(mylist)

map2(paste0("Graphs/", names(mylist), ".png"),
     mylist,
     ggsave,
     units = "in",
     width = 7.3,
     height = 432/700 * 7.3,
     dpi = 300)
```
